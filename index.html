<!DOCTYPE html>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.6.172/build/pdf.min.js "></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<link rel="stylesheet" href="https://cdn.simplecss.org/simple.min.css" />
<script type="module">
  const pdfjs = window["pdfjs-dist/build/pdf"];
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdn.jsdelivr.net/npm/pdfjs-dist@3.6.172/build/pdf.worker.js";

  const readFile = (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.addEventListener("loadend", (event) =>
        resolve(event.target.result)
      );
      reader.readAsArrayBuffer(file);
    });
  };

  const convertToText = async (images) => {
    const worker = await Tesseract.createWorker({
      logger: (m) => console.log(m),
    });
    await worker.loadLanguage("eng");
    await worker.initialize("eng");

    const container = document.getElementById("container");
    for (const image of images) {
      const {
        data: { text },
      } = await worker.recognize(image);
      console.log(text);
      container.appendChild(document.createTextNode(text));
    }

    await worker.terminate();
  };

  const fileInput = document.getElementById("file-input");
  fileInput.addEventListener("change", async () => {
    const loadingTask = pdfjsLib.getDocument({
      data: new Uint8Array(await readFile(fileInput.files[0])),
    });

    loadingTask.promise.then(async (pdf) => {
      const container = document.getElementById("container");
      const images = [];
      for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
        const page = await pdf.getPage(pageNumber);
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement("canvas");
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        container.appendChild(canvas);
        await page.render({
          canvasContext: canvas.getContext("2d"),
          viewport: viewport,
        }).promise;
        images.push(canvas.toDataURL("image/png"));
      }
      convertToText(images);
    });
  });
</script>

<h1>pdf2text-ocr</h1>
<input type="file" id="file-input" multiple />
<div id="container"></div>

<style>
  canvas {
    display: none;
  }
</style>
